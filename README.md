# Image Moderation API

–°–µ—Ä–≤–µ—Ä –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Sightengine API.

## –û–ø–∏—Å–∞–Ω–∏–µ

API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–º—É –Ω–∞–±–æ—Ä—É –ø—Ä–∞–≤–∏–ª 
(–Ω–∞–≥–æ—Ç–∞, –Ω–∞—Å–∏–ª–∏–µ, –æ—Ä—É–∂–∏–µ –∏ —Ç.–¥.), –∏—Å–ø–æ–ª—å–∑—É—è –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –æ—Ç [Sightengine](https://sightengine.com/).

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–Ω–∞–≥–æ—Ç–∞, –Ω–∞—Å–∏–ª–∏–µ, –æ—Ä—É–∂–∏–µ –∏ –¥—Ä.), –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º —á–µ—Ä–µ–∑ `.env`.
- ‚úÖ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç–æ–≤ JPG, JPEG, PNG.
- ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª –º–æ–¥–µ—Ä–∞—Ü–∏–∏.
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π.
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –±–∞–∑–µ FastAPI.
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ


## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone https://github.com/DalekTek/image_moderation_api
cd image_moderation_api
```

### 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
SIGHTENGINE_API_USER="your_sightengine_api_user_key"
SIGHTENGINE_API_SECRET="your_sightengine_api_secret_key"

# –ù–∞—Å—Ç—Ä–æ–π—Ç–µ, –∫–∞–∫–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å (–ø–µ—Ä–µ—á–∏—Å–ª–∏—Ç–µ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
# –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏: nudity-2.0, violence, weapon, gore, recreational_drug, alcohol, offensive
MODERATION_MODELS="nudity-2.0,violence,weapon"

# –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
HOST=127.0.0.1
PORT=8000
DEBUG=false

NSFW_THRESHOLD=0.7
MAX_FILE_SIZE=10485760 # 10MB
```

### 4*. –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π Sightengine

1. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ [Sightengine](https://sightengine.com/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à Dashboard. 
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª API Keys 
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à API user –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `SIGHTENGINE_API_USER` –≤ —Ñ–∞–π–ª–µ `.env`
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤–∞—à API secret –∫–ª—é—á –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `SIGHTENGINE_API_SECRET` –≤ —Ñ–∞–π–ª–µ `.env`

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```bash
uvicorn main:app --host 0.0.0.0 --port 8000
```

## API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### POST /moderate

–û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `file` (multipart/form-data): –§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (.jpg, .jpeg, .png)

**–û—Ç–≤–µ—Ç—ã:**

‚úÖ **–£—Å–ø–µ—à–Ω–∞—è –º–æ–¥–µ—Ä–∞—Ü–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ):**
```json
{
  "status": "OK",
  "scores": {
    "nudity_score": 0.05,
    "violence_score": 0.1,
    "weapon_score": 0.02
  }
}
```

‚ùå **–û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç:**
```json
{
  "status": "REJECTED",
  "reason": "Nudity content, Violence content",
  "scores": {
    "nudity_score": 0.85,
    "violence_score": 0.91,
    "weapon_score": 0.1
  }
}
```

üö´ **–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
```json
{
  "detail": "File extension 'gif' not allowed. Allowed extensions: jpg, jpeg, png"
}
```

### `GET /` –∏ `GET /health`

–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞.

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### cURL

```bash
# –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
curl -X POST \
  -F "file=@example.jpg" \
  http://localhost:8000/moderate

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
curl http://localhost:8000/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
curl http://localhost:8000/health
```

### Python `requests`

```python
import requests

# –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
with open('example.jpg', 'rb') as f:
    files = {'file': f}
    response = requests.post('http://localhost:8000/moderate', files=files)
    print(response.json())
```

### Postman

1. –°–æ–∑–¥–∞–π—Ç–µ POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `http://localhost:8000/moderate`
2. –í —Ä–∞–∑–¥–µ–ª–µ Body –≤—ã–±–µ—Ä–∏—Ç–µ "form-data"
3. –î–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á "file" —Ç–∏–ø–∞ "File"
4. –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
5. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
image-moderation-api/
‚îú‚îÄ‚îÄ main.py                          # –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI
‚îú‚îÄ‚îÄ requirements.txt                 # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
‚îú‚îÄ‚îÄ README.md                        # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
‚îú‚îÄ‚îÄ .env                             # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (—Å–æ–∑–¥–∞—Ç—å)
‚îî‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ services/
    ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
    ‚îÇ   ‚îî‚îÄ‚îÄ moderation_service.py    # C–µ—Ä–≤–∏—Å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    ‚îú‚îÄ‚îÄ __init__.py
    ‚îú‚îÄ‚îÄ analyzers.py
    ‚îú‚îÄ‚îÄ clients.py                   
    ‚îú‚îÄ‚îÄ config.py                    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    ‚îú‚îÄ‚îÄ exceptions.py                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    ‚îî‚îÄ‚îÄ validators.py                # –í–∞–ª–∏–¥–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```
## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å Docker

–í—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.

**Dockerfile:**
```dockerfile
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ Python
FROM python:3.11-slim

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
COPY ./src ./src
COPY main.py .

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç
EXPOSE 8000

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ uvicorn
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

**–°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫:**
```bash
# –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞
docker build -t image-moderation-api .

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π .env —Ñ–∞–π–ª–∞
docker run -d -p 8000:8000 --env-file .env --name moderation-app image-moderation-api
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è     | –û–ø–∏—Å–∞–Ω–∏–µ                    | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é        |
|--------------------------|-----------------------------|------------------------------|
| `SIGHTENGINE_API_USER`   | API user –∫–ª—é—á Sightengine   | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**              |
| `SIGHTENGINE_API_SECRET` | API secret –∫–ª—é—á Sightengine | **–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ**              |
| `MODERATION_MODELS`      | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏          | `nudity-2.0,violence,weapon` |
| `HOST`                   | –•–æ—Å—Ç —Å–µ—Ä–≤–µ—Ä–∞                | `127.0.0.1`                  |
| `PORT`                   | –ü–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞                | `8000`                       |
| `DEBUG`                  | –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏               | `false`                      |
| `NSFW_THRESHOLD`         | –ü–æ—Ä–æ–≥ NSFW (0.0-1.0)        | `0.7`                        |
| `MAX_FILE_SIZE`          | –ú–∞–∫—Å. —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–±–∞–π—Ç—ã)  | `10485760` (10MB)            |


## –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è
```bash
black .
isort .

flake8 .
```

## –õ–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–µ–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:
- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ –≤ `logs/app.log`
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License
